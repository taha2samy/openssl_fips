
{% set scan_data = distroless_compliance['security_scan'] %}

{# --- 1. Logic: Safe Data Extraction for Distroless --- #}
{% set trivy_version = scan_data['Trivy']['Version'] if 'Trivy' in scan_data else '0.0.0' %}
{% set artifact_name = scan_data['ArtifactName'] if 'ArtifactName' in scan_data else 'Distroless Image' %}

{% set ns = namespace(vulns=[], critical=0, high=0, medium=0, low=0, pkg_count=0, fixable=0) %}

{% if 'Results' in scan_data %}
  {% for res in scan_data['Results'] %}
    {# Count All Packages in the minimal Distroless rootfs #}
    {% if 'Packages' in res and res['Packages'] %}
      {% set ns.pkg_count = ns.pkg_count + (res['Packages'] | length) %}
    {% endif %}
    
    {# Process Vulnerabilities #}
    {% if 'Vulnerabilities' in res and res['Vulnerabilities'] %}
      {% set ns.vulns = ns.vulns + res['Vulnerabilities'] %}
      {% for v in res['Vulnerabilities'] %}
        {% set sev = v['Severity'] if 'Severity' in v else 'UNKNOWN' %}
        {% if sev == "CRITICAL" %}{% set ns.critical = ns.critical + 1 %}{% endif %}
        {% if sev == "HIGH" %}{% set ns.high = ns.high + 1 %}{% endif %}
        {% if sev == "MEDIUM" %}{% set ns.medium = ns.medium + 1 %}{% endif %}
        {% if sev == "LOW" %}{% set ns.low = ns.low + 1 %}{% endif %}
        {% if v['FixedVersion'] %}{% set ns.fixable = ns.fixable + 1 %}{% endif %}
      {% endfor %}
    {% endif %}
  {% endfor %}
{% endif %}

{% set total_vulns = ns.vulns | length %}

# :fontawesome-solid-user-shield: Vulnerability Assessment (Distroless)

**Target Image:** `{{ artifact_name }}`
**Scanner:** `Trivy v{{ trivy_version }}` &nbsp;|&nbsp; **Profile:** `Production / Hardened`

---

## :material-radar: Threat Landscape Overview

<div class="grid cards" markdown>

-   :material-virus: **Total CVEs Found**
    ---
    {% if total_vulns == 0 -%}
    <span style="color: #00c853; font-size: 3em; font-weight: 900;">0</span>
    {% else -%}
    <span style="color: #d50000; font-size: 3em; font-weight: 900;">{{ total_vulns }}</span>
    {% endif -%}
    *Production Risk Level*

-   :material-package-variant-closed: **Minimal SBOM**
    ---
    <span style="font-size: 2.2em; font-weight: bold; color: #424242;">{{ ns.pkg_count }}</span>
    <span style="font-size: 0.8em; color: #9e9e9e;">Total Components</span>
    *No Shell / No APK*

-   :material-lightning-bolt: **Critical / High**
    ---
    {% if (ns.critical + ns.high) == 0 -%}
    <span style="color: #00c853; font-size: 2.2em; font-weight: bold;">0</span>
    {% else -%}
    <span style="color: #d50000; font-size: 2.2em; font-weight: 900;">{{ ns.critical + ns.high }}</span>
    {% endif -%}
    *Immediate Patching*

-   :material-information: **Medium / Low**
    ---
    {% if (ns.medium + ns.low) == 0 -%}
    <span style="color: #00c853; font-size: 2.2em; font-weight: bold;">0</span>
    {% else -%}
    <span style="color: #ffb300; font-size: 2.2em; font-weight: bold;">{{ ns.medium + ns.low }}</span>
    {% endif -%}
    *Risk Mitigation Required*

</div>

{% if total_vulns == 0 %}
!!! success "Zero-CVE State Confirmed :material-check-decagram:"
    **Gold Standard Integrity:** This Distroless image contains zero known vulnerabilities. Its minimal footprint and lack of shell environments provide the most secure foundation for production workloads.
{% else %}
!!! warning "Remediation Required :material-alert:"
    Security flaws were detected in the production image. Refer to the remediation plan below to restore the **Zero-CVE** status.
{% endif %}

---

## :material-chart-donut: Severity Distribution

{% if total_vulns > 0 %}
```vegalite
{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "data": {
    "values": [
      {"category": "Critical", "value": {{ ns.critical }}, "color": "#d32f2f"},
      {"category": "High", "value": {{ ns.high }}, "color": "#f57c00"},
      {"category": "Medium", "value": {{ ns.medium }}, "color": "#fbc02d"},
      {"category": "Low", "value": {{ ns.low }}, "color": "#1976d2"}
    ]
  },
  "transform": [{ "filter": "datum.value > 0" }],
  "mark": {"type": "arc", "innerRadius": 50, "tooltip": true, "stroke": "#fff"},
  "encoding": {
    "theta": {"field": "value", "type": "quantitative"},
    "color": {
      "field": "category", "type": "nominal",
      "scale": {"domain": ["Critical", "High", "Medium", "Low"], "range": ["#d32f2f", "#f57c00", "#fbc02d", "#1976d2"]},
      "legend": {"title": "Severity Level"}
    }
  },
  "width": "container", "height": 200
}
```
{% else %}
<div style="text-align: center; padding: 40px; background: #f1f8e9; border-radius: 8px; border: 2px dashed #c8e6c9;">
    <span style="font-size: 3.5em;">üõ°Ô∏è</span><br>
    <h3 style="color: #2e7d32;">Verified Safe: No Threats Detected</h3>
</div>
{% endif %}

---

## :material-table-eye: Detailed Forensic Log

{% if total_vulns > 0 %}
| Severity | CVE ID | Affected Package | Status | Fix Available | Details |
| :---: | :--- | :--- | :--- | :---: | :---: |
{% for v in ns.vulns -%}
| {% if v['Severity'] == 'CRITICAL' %}:material-lightning-bolt:{ .md-typeset__error }{% elif v['Severity'] == 'HIGH' %}:material-alert:{ style="color: #f57c00" }{% else %}:material-alert-circle:{ style="color: #fbc02d" }{% endif %} | [`{{ v['VulnerabilityID'] }}`]({{ v['PrimaryURL'] }}) | `{{ v['PkgName'] }}` | {{ v['Status'] | title }} | {% if v['FixedVersion'] %}:material-check-circle:{ style="color: #4caf50" } Yes{% else %}:material-help-circle:{ style="color: #9e9e9e" } No{% endif %} | [:material-link-variant: View]({{ v['PrimaryURL'] }}) |
{% endfor %}

### :material-comment-alert: Audit Strategy Note
!!! note "Production Remediation"
    *   **Patch Status:** **{{ ns.fixable }}** of **{{ total_vulns }}** issues have fixes.
    *   **Action:** Distroless images are updated by **re-building** from the latest parent digests.
{% endif %}

---

## :material-identifier: Traceability Metadata

| Field | Value |
| :--- | :--- |
| **Artifact Name** | `{{ artifact_name }}` |
| **Image Digest** | `{{ scan_data['ArtifactID'] | default('N/A') }}` |
| **Scanner Engine** | `Trivy v{{ trivy_version }}` |
| **Audit Status** | {% if total_vulns == 0 %}PASSED{% else %}ACTION REQUIRED{% endif %} |

---

## :material-package-variant-closed: Distroless SBOM Inventory

| Package Name | Version | Licenses | Classification |
| :--- | :--- | :--- | :--- |
{% if 'Results' in scan_data -%}
  {% for res in scan_data['Results'] -%}
    {% if 'Packages' in res and res['Packages'] -%}
      {% for p in res['Packages'] -%}
| **`{{ p['Name'] }}`** | `{{ p['Version'] }}` | {{ p['Licenses'] | join(', ') if p['Licenses'] is iterable and p['Licenses'] is not string else p['Licenses'] | default('N/A') }} | :material-shield-home: Distroless Core |
      {% endfor -%}
    {% endif -%}
  {% endfor -%}
{% endif -%}

---

!!! tip "Security Transparency & SLSA Compliance"
    The full signed SBOM for the Distroless image is available for download.
    **[:material-file-download: Download Distroless SBOM JSON]({{ distroless_sbom_url }})**

[:material-arrow-up: Back to Top](#vulnerability-assessment-distroless)
