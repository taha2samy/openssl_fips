{% set scan_data = standard_compliance['security_scan'] %}

{# --- 1. Safe Metadata Extraction --- #}
{% set trivy_version = scan_data['Trivy']['Version'] if 'Trivy' in scan_data else '0.0.0' %}
{% set artifact_name = scan_data['ArtifactName'] if 'ArtifactName' in scan_data else 'Standard Image' %}

{# --- 2. Initialize Namespace (MUST use dot notation later) --- #}
{% set ns = namespace(vulns=[], critical=0, high=0, medium=0, low=0, pkg_count=0, fixable=0) %}

{# --- 3. Loop and Force Count --- #}
{% if 'Results' in scan_data %}
  {% for res in scan_data['Results'] %}
    
    {# Count Packages #}
    {% if 'Packages' in res and res['Packages'] %}
      {% set ns.pkg_count = ns.pkg_count + (res['Packages'] | length) %}
    {% endif %}
    
    {# Extract and Count Vulnerabilities #}
    {% if 'Vulnerabilities' in res and res['Vulnerabilities'] %}
      {% set ns.vulns = ns.vulns + res['Vulnerabilities'] %}
      
      {% for v in res['Vulnerabilities'] %}
        {% set sev = v['Severity'] if 'Severity' in v else 'UNKNOWN' %}
        {% if sev == "CRITICAL" %}{% set ns.critical = ns.critical + 1 %}{% endif %}
        {% if sev == "HIGH" %}{% set ns.high = ns.high + 1 %}{% endif %}
        {% if sev == "MEDIUM" %}{% set ns.medium = ns.medium + 1 %}{% endif %}
        {% if sev == "LOW" %}{% set ns.low = ns.low + 1 %}{% endif %}
        
        {% if v['FixedVersion'] %}
          {% set ns.fixable = ns.fixable + 1 %}
        {% endif %}
      {% endfor %}
    {% endif %}
    
  {% endfor %}
{% endif %}

{% set total_vulns = ns.vulns | length %}


# :fontawesome-solid-user-secret: Vulnerability Impact Assessment

**Target Image:** `{{ artifact_name }}`
**Scanner:** `Trivy v{{ trivy_version }}` &nbsp;|&nbsp; **Strategy:** `Zero-CVE Enforcement`

---

## :material-radar: Threat Landscape Overview

<div class="grid cards" markdown>

-   :material-virus: **Total CVEs Found**
    ---
    {% if total_vulns == 0 -%}
    <span style="color: #00c853; font-size: 3em; font-weight: 900;">0</span>
    {% else -%}
    <span style="color: #d50000; font-size: 3em; font-weight: 900;">{{ total_vulns }}</span>
    {% endif -%}
    
    *Detected in Image Layers*

-   :material-package-variant-closed: **Packages Analyzed**
    ---
    <span style="font-size: 2.2em; font-weight: bold; color: #424242;">{{ ns.pkg_count }}</span>
    <span style="font-size: 0.8em; color: #9e9e9e;">Total Dependencies</span>
    
    *Software Bill of Materials (SBOM)*

-   :material-lightning-bolt: **Critical / High**
    ---
    {% if (ns.critical + ns.high) == 0 -%}
    <span style="color: #00c853; font-size: 2.2em; font-weight: bold;">0</span>
    {% else -%}
    <span style="color: #d50000; font-size: 2.2em; font-weight: 900;">{{ ns.critical + ns.high }}</span>
    {% endif -%}
    
    *Requires Immediate Patching*

-   :material-information: **Medium / Low**
    ---
    {% if (ns.medium + ns.low) == 0 -%}
    <span style="color: #00c853; font-size: 2.2em; font-weight: bold;">0</span>
    {% else -%}
    <span style="color: #ffb300; font-size: 2.2em; font-weight: bold;">{{ ns.medium + ns.low }}</span>
    {% endif -%}
    
    *Risk Mitigation Required*

</div>

{% if total_vulns == 0 %}
!!! success "Zero-CVE State Confirmed :material-check-decagram:"
    **Impeccable Security Posture:** No known vulnerabilities (CVEs) were detected in the `{{ ns.pkg_count }}` analyzed packages. This image represents the **Gold Standard** for production deployment.
{% else %}
!!! warning "Vulnerability Remediation Required :material-alert:"
    **{{ total_vulns }} security exception(s)** were identified. Review the detailed forensic log and remediation plan below to restore the **Zero-CVE** status.
{% endif %}



## :material-chart-donut: Severity Distribution

{# --- Check if we have vulnerabilities to visualize --- #}
{% if total_vulns > 0 %}
!!! info "Visual Risk Profile"
    The chart below represents the distribution of vulnerabilities by severity level.
    
```vegalite
{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "Vulnerability Severity Distribution",
  "data": {
    "values": [
      {"category": "Critical", "value": {{ ns.critical }}, "color": "#d32f2f"},
      {"category": "High", "value": {{ ns.high }}, "color": "#f57c00"},
      {"category": "Medium", "value": {{ ns.medium }}, "color": "#fbc02d"},
      {"category": "Low", "value": {{ ns.low }}, "color": "#1976d2"}
    ]
  },
  "transform": [
    { "filter": "datum.value > 0" }
  ],
  "mark": {"type": "arc", "innerRadius": 60, "tooltip": true, "stroke": "#fff", "strokeWidth": 2},
  "encoding": {
    "theta": {"field": "value", "type": "quantitative"},
    "color": {
      "field": "category", 
      "type": "nominal",
      "scale": {
        "domain": ["Critical", "High", "Medium", "Low"], 
        "range": ["#d32f2f", "#f57c00", "#fbc02d", "#1976d2"]
      },
      "legend": {
        "title": "Severity",
        "orient": "right",
        "labelFontSize": 14,
        "titleFontSize": 16
      }
    }
  },
  "config": {
    "view": {"stroke": null}
  },
  "width": "container",
  "height": 250
}
```
{% else %}
<div style="text-align: center; padding: 40px; background: #f1f8e9; border-radius: 12px; border: 2px dashed #81c784; margin: 20px 0;">
    <div style="font-size: 4em; margin-bottom: 10px;">üõ°Ô∏è</div>
    <h3 style="color: #2e7d32; font-weight: 800; margin: 0;">Clean Security Signature</h3>
    <p style="color: #558b2f; font-size: 1.1em; margin-top: 5px;">
        No active threats detected in the <b>{{ ns.pkg_count }}</b> analyzed components.<br>
        This image satisfies the <b>Zero-Vulnerability</b> deployment threshold.
    </p>
</div>
{% endif %}


---

## :material-table-eye: Detailed Forensic Log

{# --- Table View for Vulnerabilities --- #}
{% if total_vulns > 0 %}
| Severity | CVE ID | Affected Package | Status | Fix Available | Exploit Info |
| :---: | :--- | :--- | :--- | :---: | :---: |
{% for v in ns.vulns -%}
| {% if v['Severity'] == 'CRITICAL' %}:material-lightning-bolt:{ .md-typeset__error title="CRITICAL" }{% elif v['Severity'] == 'HIGH' %}:material-alert:{ style="color: #f57c00" title="HIGH" }{% else %}:material-alert-circle:{ style="color: #fbc02d" title="MEDIUM" }{% endif %} | [`{{ v['VulnerabilityID'] }}`]({{ v['PrimaryURL'] }}) | `{{ v['PkgName'] }}` | {{ v['Status'] | title | default('Affected') }} | {% if v['FixedVersion'] %}:material-check-circle:{ style="color: #4caf50" title="Fixed in {{ v['FixedVersion'] }}" } Yes{% else %}:material-help-circle:{ style="color: #9e9e9e" } Pending{% endif %} | [:material-link-variant: Details]({{ v['PrimaryURL'] }}) |
{% endfor %}
{% else %}
!!! success "Clean Component Manifest"
    All installed packages have been cross-referenced with the **Wolfi Security Database**. No actionable vulnerabilities were found in the current build layers.
{% endif %}

---

### :material-identifier: Traceability Metadata
These identifiers ensure the integrity and reproducibility of this specific security audit.

| Field | Value |
| :--- | :--- |
| **Artifact Name** | `{{ artifact_name }}` |
| **Image Digest** | `{{ scan_data['ArtifactID'] | default('N/A') }}` |
| **Scanner Engine** | `Trivy v{{ trivy_version }}` |
| **Report Generated** | `{{ scan_data['CreatedAt'] | default('N/A') }}` |
| **Audit Status** | {% if total_vulns == 0 %}<span style="color: #00c853; font-weight: bold;">:material-check-decagram: PASSED</span>{% else %}<span style="color: #d50000; font-weight: bold;">:material-alert: ACTION REQUIRED ({{ total_vulns }} Issue found)</span>{% endif %} |

---

### :material-shield-search: Remediation Guidance

{% if total_vulns > 0 %}
1.  **Fix Availability:** Check the `Fix Available` column. If it says **Yes**, update your Dockerfile or trigger a new build to pull the latest Wolfi patches.
2.  **Exploitability:** Click on the **Details** link for each CVE. This will take you to the official NVD/GitHub Advisory page where you can see if a **Public Exploit** (PoC) exists.
3.  **Audit Status:** The status `ACTION REQUIRED` will remain until a new scan confirms that `Fixed Version` has been applied.
{% else %}
*No remediation required. System is at peak security posture.*
{% endif %}



{% if total_vulns > 0 %}

!!! note "Understanding 'ACTION REQUIRED'"
    The status **ACTION REQUIRED** is triggered because our policy enforces a **Strict Zero-CVE** threshold. 

    **What does this mean?**
    
    *   **Patch Availability:** Currently, **{{ ns.fixable }}** out of **{{ total_vulns }}** vulnerabilities have a verified fix available from upstream vendors (Wolfi/Chainguard).
    *   **Immediate Action:** For the **{{ ns.fixable }} fixable** issues (like the `zlib` component identified in this report), the required action is a **Pipeline Re-trigger**. 
    *   **Why a Re-trigger?** Since our `Dockerfile` pulls from Wolfi's rolling repositories, a simple rebuild will fetch the latest secure versions and clear this flag without changing code.

    **Security Conclusion:**
    The image is functionally secure, but "Audit-Stale." Maintaining this report ensures 100% transparency in our cryptographic supply chain.
{% else %}
!!! success "Clean Slate Policy"
    The **Audit Status: PASSED** confirms that the image contains zero known vulnerabilities. No manual intervention is required.
{% endif %}

## :material-package-variant-closed: Software Bill of Materials (SBOM)

This inventory provides a granular list of all system-level and application-level components installed within the image layers.

| Package Name | Version | Licenses | Classification |
| :--- | :--- | :--- | :--- |
{% if 'Results' in scan_data -%}
  {% for res in scan_data['Results'] -%}
    {% if 'Packages' in res and res['Packages'] -%}
      {% for p in res['Packages'] -%}
| **`{{ p['Name'] }}`** | `{{ p['Version'] }}` | {{ p['Licenses'] | join(', ') if p['Licenses'] is iterable and p['Licenses'] is not string else p['Licenses'] | default('N/A') }} | {% if res['Class'] == 'os-pkgs' %}:material-linux: System (Wolfi){% else %}:material-package-variant: Application{% endif %} |
      {% endfor -%}
    {% endif -%}
  {% endfor -%}
{% else -%}
| :material-alert-circle: | No packages identified | N/A | N/A |
{% endif -%}

---

### :material-scale-balance: License & Inventory Summary

*   **Total Verified Components:** `{{ ns.pkg_count }}` Packages.
*   **Audit Method:** Static analysis of container rootfs via Trivy.
*   **Data Integrity:** Cross-referenced with the official **Wolfi OS** advisory database.


!!! tip "Security Transparency & SLSA Compliance"
    This Software Bill of Materials (SBOM) is a core requirement for meeting **SLSA Level 3** standards. It ensures absolute transparency in cryptographic workloads. 
    **[:material-file-download: Download SBOM JSON]({{ standard_sbom_url }})**

